"use strict";(self.webpackChunknestjs_mod_com=self.webpackChunknestjs_mod_com||[]).push([[1174],{4264:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>m,frontMatter:()=>r,metadata:()=>a,toc:()=>d});var t=s(4848),o=s(8453);const r={},i="@nestjs-mod/flyway",a={id:"packages/infrastructure/flyway/README",title:"@nestjs-mod/flyway",description:"Flyway - utility for working with database migrations (official site//flywaydb.org, preview version only for Postgres)",source:"@site/docs/packages/infrastructure/flyway/README.md",sourceDirName:"packages/infrastructure/flyway",slug:"/packages/infrastructure/flyway/",permalink:"/docs/packages/infrastructure/flyway/",draft:!1,unlisted:!1,editUrl:"https://github.com/nestjs-mod/nestjs-mod.com/blob/master/docs/packages/infrastructure/flyway/README.md",tags:[],version:"current",frontMatter:{},sidebar:"packagesSidebar",previous:{title:"@nestjs-mod/docker-compose",permalink:"/docs/packages/infrastructure/docker-compose/"},next:{title:"@nestjs-mod/pm2",permalink:"/docs/packages/infrastructure/pm2/"}},l={},d=[{value:"Installation",id:"installation",level:2},{value:"Modules",id:"modules",level:2},{value:"Modules descriptions",id:"modules-descriptions",level:2},{value:"Flyway",id:"flyway",level:3},{value:"Use in NestJS-mod",id:"use-in-nestjs-mod",level:4},{value:"Environments",id:"environments",level:4},{value:"Static configuration",id:"static-configuration",level:4},{value:"Links",id:"links",level:2},{value:"License",id:"license",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"nestjs-modflyway",children:"@nestjs-mod/flyway"}),"\n",(0,t.jsxs)(n.p,{children:["Flyway - utility for working with database migrations (official site: ",(0,t.jsx)(n.a,{href:"https://flywaydb.org",children:"https://flywaydb.org"}),", preview version only for Postgres)"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.a,{href:"https://npmjs.org/package/@nestjs-mod/flyway",children:(0,t.jsx)(n.img,{src:"https://badgen.net/npm/v/@nestjs-mod/flyway",alt:"NPM version"})})," ",(0,t.jsx)(n.a,{href:"https://npmjs.org/package/@nestjs-mod/flyway",children:(0,t.jsx)(n.img,{src:"https://badgen.net/npm/dm/@nestjs-mod/flyway",alt:"monthly downloads"})})," ",(0,t.jsx)(n.a,{href:"https://t.me/nestjs_mod",children:(0,t.jsx)(n.img,{src:"https://img.shields.io/badge/group-telegram-blue.svg?maxAge=2592000",alt:"Telegram"})})," ",(0,t.jsx)(n.a,{href:"https://discord.gg/meY7UXaG",children:(0,t.jsx)(n.img,{src:"https://img.shields.io/badge/discord-online-brightgreen.svg",alt:"Discord"})})]}),"\n",(0,t.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"npm i --save-dev node-flywaydb@3.0.7\nnpm i --save @nestjs-mod/flyway\n"})}),"\n",(0,t.jsx)(n.h2,{id:"modules",children:"Modules"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Link"}),(0,t.jsx)(n.th,{children:"Category"}),(0,t.jsx)(n.th,{children:"Description"})]})}),(0,t.jsx)(n.tbody,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{href:"#flyway",children:"Flyway"})}),(0,t.jsx)(n.td,{children:"infrastructure"}),(0,t.jsxs)(n.td,{children:["Flyway - utility for working with database migrations (official site: ",(0,t.jsx)(n.a,{href:"https://flywaydb.org",children:"https://flywaydb.org"}),", preview version only for Postgres)"]})]})})]}),"\n",(0,t.jsx)(n.h2,{id:"modules-descriptions",children:"Modules descriptions"}),"\n",(0,t.jsx)(n.h3,{id:"flyway",children:"Flyway"}),"\n",(0,t.jsxs)(n.p,{children:["Flyway - utility for working with database migrations (official site: ",(0,t.jsx)(n.a,{href:"https://flywaydb.org",children:"https://flywaydb.org"}),", preview version only for Postgres)"]}),"\n",(0,t.jsx)(n.h4,{id:"use-in-nestjs-mod",children:"Use in NestJS-mod"}),"\n",(0,t.jsxs)(n.p,{children:["An example you can see the full example here ",(0,t.jsx)(n.a,{href:"https://github.com/nestjs-mod/nestjs-mod-contrib/tree/master/apps/example-prisma-flyway",children:"https://github.com/nestjs-mod/nestjs-mod-contrib/tree/master/apps/example-prisma-flyway"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { PACKAGE_JSON_FILE, ProjectUtils, bootstrapNestApplication } from '@nestjs-mod/common';\nimport { DOCKER_COMPOSE_FILE, DockerCompose, DockerComposePostgreSQL } from '@nestjs-mod/docker-compose';\nimport { FLYWAY_JS_CONFIG_FILE, Flyway } from '@nestjs-mod/flyway';\nimport { join } from 'path';\n\nexport const flywayPrismaFeatureName = 'flyway-prisma';\n\nconst rootFolder = join(__dirname, '..', '..', '..');\nconst appFolder = join(rootFolder, 'apps', 'example-prisma-flyway');\n\nbootstrapNestApplication({\n  modules: {\n    system: [\n      ProjectUtils.forRoot({\n        staticConfiguration: {\n          applicationPackageJsonFile: join(appFolder, PACKAGE_JSON_FILE),\n          packageJsonFile: join(rootFolder, PACKAGE_JSON_FILE),\n          envFile: join(rootFolder, '.env'),\n        },\n      }),\n    ],\n    infrastructure: [\n      DockerCompose.forRoot({\n        configuration: {\n          dockerComposeFileVersion: '3',\n          dockerComposeFile: join(appFolder, DOCKER_COMPOSE_FILE),\n        },\n      }),\n      DockerComposePostgreSQL.forRoot(),\n      DockerComposePostgreSQL.forFeature({\n        featureModuleName: flywayPrismaFeatureName,\n      }),\n      Flyway.forRoot({\n        staticConfiguration: {\n          featureName: flywayPrismaFeatureName,\n          migrationsFolder: join(appFolder, 'src', 'migrations'),\n          configFile: join(rootFolder, FLYWAY_JS_CONFIG_FILE),\n        },\n      }),\n    ],\n  },\n});\n"})}),"\n",(0,t.jsxs)(n.p,{children:["After connecting the module to the application and ",(0,t.jsx)(n.code,{children:"npm run build"})," and starting generation of documentation through ",(0,t.jsx)(n.code,{children:"npm run docs:infrastructure"}),", you will have new files and scripts to run."]}),"\n",(0,t.jsxs)(n.p,{children:["New scripts mostly ",(0,t.jsx)(n.code,{children:"package.json"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "scripts": {\n    "_____flyway_____": "_____flyway_____",\n    "flyway:create:example-prisma-flyway": "./node_modules/.bin/nx run example-prisma-flyway:flyway-create-migration",\n    "flyway:migrate:example-prisma-flyway": "./node_modules/.bin/nx run example-prisma-flyway:flyway-migrate"\n  },\n  "scriptsComments": {\n    "flyway:create:example-prisma-flyway": ["Command to create new empty migration for example-prisma-flyway"],\n    "flyway:migrate:example-prisma-flyway": ["Applying migrations for example-prisma-flyway"]\n  }\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Additional commands in the nx application ",(0,t.jsx)(n.code,{children:"project.json"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "targets": {\n    "flyway-create-migration": {\n      "executor": "nx:run-commands",\n      "options": {\n        "commands": [\n          "echo \'select 1;\' > ./apps/example-prisma-flyway/src/migrations/V`date +%Y%m%d%H%M`__NewMigration.sql"\n        ],\n        "parallel": false,\n        "envFile": "./.env",\n        "color": true\n      }\n    },\n    "flyway-migrate": {\n      "executor": "nx:run-commands",\n      "options": {\n        "commands": [\n          "export DATABASE_URL=${EXAMPLE_PRISMA_FLYWAY_FLYWAY_PRISMA_DATABASE_URL} && export DATABASE_MIGRATIONS_LOCATIONS=./apps/example-prisma-flyway/src/migrations && ./node_modules/.bin/flyway -c ./.flyway.js migrate"\n        ],\n        "parallel": false,\n        "envFile": "./.env",\n        "color": true\n      }\n    },\n    "flyway-info": {\n      "executor": "nx:run-commands",\n      "options": {\n        "commands": [\n          "export DATABASE_URL=${EXAMPLE_PRISMA_FLYWAY_FLYWAY_PRISMA_DATABASE_URL} && export DATABASE_MIGRATIONS_LOCATIONS=./apps/example-prisma-flyway/src/migrations && ./node_modules/.bin/flyway -c ./.flyway.js info"\n        ],\n        "parallel": false,\n        "envFile": "./.env",\n        "color": true\n      }\n    },\n    "flyway-baseline": {\n      "executor": "nx:run-commands",\n      "options": {\n        "commands": [\n          "export DATABASE_URL=${EXAMPLE_PRISMA_FLYWAY_FLYWAY_PRISMA_DATABASE_URL} && export DATABASE_MIGRATIONS_LOCATIONS=./apps/example-prisma-flyway/src/migrations && ./node_modules/.bin/flyway -c ./.flyway.js baseline"\n        ],\n        "parallel": false,\n        "envFile": "./.env",\n        "color": true\n      }\n    },\n    "flyway-validate": {\n      "executor": "nx:run-commands",\n      "options": {\n        "commands": [\n          "export DATABASE_URL=${EXAMPLE_PRISMA_FLYWAY_FLYWAY_PRISMA_DATABASE_URL} && export DATABASE_MIGRATIONS_LOCATIONS=./apps/example-prisma-flyway/src/migrations && ./node_modules/.bin/flyway -c ./.flyway.js validate"\n        ],\n        "parallel": false,\n        "envFile": "./.env",\n        "color": true\n      }\n    },\n    "flyway-repair": {\n      "executor": "nx:run-commands",\n      "options": {\n        "commands": [\n          "export DATABASE_URL=${EXAMPLE_PRISMA_FLYWAY_FLYWAY_PRISMA_DATABASE_URL} && export DATABASE_MIGRATIONS_LOCATIONS=./apps/example-prisma-flyway/src/migrations && ./node_modules/.bin/flyway -c ./.flyway.js repair"\n        ],\n        "parallel": false,\n        "envFile": "./.env",\n        "color": true\n      }\n    }\n  }\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Common config for flyway ",(0,t.jsx)(n.code,{children:".flyway.js"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-javascript",children:"const { ConnectionString } = require('connection-string');\nconst cs = new ConnectionString(process.env.DATABASE_URL);\nconst {\n  user: USERNAME,\n  password: PASSWORD,\n  HOST = cs.host,\n  DATABASE = cs.path && cs.path[0],\n  SCHEMA = cs.params && cs.params.schema,\n  SCHEMAS = cs.params && cs.params.schemas,\n} = cs;\n\nmodule.exports = {\n  flywayArgs: {\n    url: `jdbc:postgresql://${HOST}/${DATABASE}`,\n    schemas: SCHEMAS || SCHEMA,\n    defaultSchema: SCHEMA,\n    locations: `filesystem:${process.env.DATABASE_MIGRATIONS_LOCATIONS || 'migrations'}`,\n    user: USERNAME,\n    password: PASSWORD,\n    table: '__migrations',\n    sqlMigrationSuffixes: '.sql',\n  },\n  // Use to configure environment variables used by flyway\n  env: {\n    JAVA_ARGS: '-Djava.util.logging.config.file=./conf/logging.properties',\n  },\n  version: '10.1.0', // optional, empty or missing will download the latest\n  mavinPlugins: [\n    {\n      // optional, use to add any plugins (ie. logging)\n      groupId: 'org.slf4j',\n      artifactId: 'slf4j-api',\n      version: '1.7.36',\n      // This can be a specifc url to download that may be different then the auto generated url.\n      downloadUrl: 'https://repo1.maven.org/maven2/org/slf4j/slf4j-api/1.7.36/slf4j-api-1.7.36.jar',\n    },\n    {\n      groupId: 'org.slf4j',\n      artifactId: 'slf4j-jdk14',\n      version: '1.7.36',\n    },\n  ],\n  downloads: {\n    storageDirectory: `${__dirname}/tmp`, // optional, the specific directory to store the flyway downloaded files. The directory must be writable by the node app process' user.\n    expirationTimeInMs: -1, // optional, -1 will never check for updates, defaults to 1 day.\n  },\n};\n"})}),"\n",(0,t.jsx)(n.h4,{id:"environments",children:"Environments"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Key"}),(0,t.jsx)(n.th,{children:"Description"}),(0,t.jsx)(n.th,{children:"Sources"}),(0,t.jsx)(n.th,{children:"Constraints"}),(0,t.jsx)(n.th,{children:"Default"}),(0,t.jsx)(n.th,{children:"Value"})]})}),(0,t.jsx)(n.tbody,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"databaseUrl"})}),(0,t.jsxs)(n.td,{children:["Connection string for database with credentials (example: postgres://feat",":feat_password","@localhost:5432/feat?schema=public)"]}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"obj['databaseUrl']"}),", ",(0,t.jsx)(n.code,{children:"process.env['DATABASE_URL']"})]}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.strong,{children:"isNotEmpty"})," (databaseUrl should not be empty)"]}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"})]})})]}),"\n",(0,t.jsx)(n.h4,{id:"static-configuration",children:"Static configuration"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Key"}),(0,t.jsx)(n.th,{children:"Description"}),(0,t.jsx)(n.th,{children:"Constraints"}),(0,t.jsx)(n.th,{children:"Default"}),(0,t.jsx)(n.th,{children:"Value"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"featureName"})}),(0,t.jsx)(n.td,{children:"Flyway feature name for generate prefix to environments keys"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"optional"})}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"migrationsFolder"})}),(0,t.jsx)(n.td,{children:"Folder with migrations"}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.strong,{children:"isNotEmpty"})," (migrationsFolder should not be empty)"]}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"configFile"})}),(0,t.jsx)(n.td,{children:"Javascript config file for flyway (.flyway.js)"}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.strong,{children:"isNotEmpty"})," (configFile should not be empty)"]}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"nxProjectJsonFile"})}),(0,t.jsx)(n.td,{children:"Application or library project.json-file (nx)"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"optional"})}),(0,t.jsx)(n.td,{children:"-"}),(0,t.jsx)(n.td,{children:"-"})]})]})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"#modules",children:"Back to Top"})}),"\n",(0,t.jsx)(n.h2,{id:"links",children:"Links"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/nestjs-mod/nestjs-mod",children:"https://github.com/nestjs-mod/nestjs-mod"})," - A collection of utilities for unifying NestJS applications and modules"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/nestjs-mod/nestjs-mod-contrib",children:"https://github.com/nestjs-mod/nestjs-mod-contrib"})," - Contrib repository for the NestJS-mod"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/nestjs-mod/nestjs-mod-example",children:"https://github.com/nestjs-mod/nestjs-mod-example"})," - Example application built with ",(0,t.jsx)(n.a,{href:"https://github.com/nestjs-mod/nestjs-mod/tree/master/libs/schematics",children:"@nestjs-mod/schematics"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/nestjs-mod/nestjs-mod/blob/master/apps/example-basic/INFRASTRUCTURE.MD",children:"https://github.com/nestjs-mod/nestjs-mod/blob/master/apps/example-basic/INFRASTRUCTURE.MD"})," - A simple example of infrastructure documentation."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/nestjs-mod/nestjs-mod-contrib/blob/master/apps/example-prisma/INFRASTRUCTURE.MD",children:"https://github.com/nestjs-mod/nestjs-mod-contrib/blob/master/apps/example-prisma/INFRASTRUCTURE.MD"})," - An extended example of infrastructure documentation with a docker-compose file and a data base."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://dev.to/endykaufman/collection-of-nestjs-mod-utilities-for-unifying-applications-and-modules-on-nestjs-5256",children:"https://dev.to/endykaufman/collection-of-nestjs-mod-utilities-for-unifying-applications-and-modules-on-nestjs-5256"})," - Article about the project NestJS-mod"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://habr.com/ru/articles/788916",children:"https://habr.com/ru/articles/788916"})," - \u041a\u043e\u043b\u043b\u0435\u043a\u0446\u0438\u044f \u0443\u0442\u0438\u043b\u0438\u0442 NestJS-mod \u0434\u043b\u044f \u0443\u043d\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u0438 \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u0439 \u0438 \u043c\u043e\u0434\u0443\u043b\u0435\u0439 \u043d\u0430 NestJS"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"license",children:"License"}),"\n",(0,t.jsx)(n.p,{children:"MIT"})]})}function m(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>i,x:()=>a});var t=s(6540);const o={},r=t.createContext(o);function i(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);